Batching in checkwatches
========================

The checkwatches system tries to be sensitive to batching options
given. Specifically, the _getRemoteIdsToCheck() method is responsible
for batching up operations.

    >>> import transaction
    >>> from lp.bugs.scripts.checkwatches import CheckwatchesMaster
    >>> from pprint import pprint

    >>> updater = CheckwatchesMaster(transaction)
    >>> transaction.commit()


Basics
------

    >>> class BasicRemoteSystem:
    ...     sync_comments = False

    >>> remote = BasicRemoteSystem()

When there are no bug watches to check, the result is empty.

    >>> pprint(updater._getRemoteIdsToCheck(
    ...     remote, [], batch_size=2))
    {'all_remote_ids': [],
     'remote_ids_to_check': [],
     'unmodified_remote_ids': []}

With up to batch_size watches, it advises us to check all the remote
bug IDs given.

    >>> bug_watches = [
    ...     factory.makeBugWatch(remote_bug='a'),
    ...     factory.makeBugWatch(remote_bug='b'),
    ...     ]
    >>> transaction.commit()

    >>> pprint(updater._getRemoteIdsToCheck(
    ...     remote, bug_watches, batch_size=2))
    {'all_remote_ids': [u'a', u'b'],
     'remote_ids_to_check': [u'a', u'b'],
     'unmodified_remote_ids': []}

With more than batch_size watches, it advises to only check a subset
of the remote bug IDs given.

    >>> bug_watches = [
    ...     factory.makeBugWatch(remote_bug='a'),
    ...     factory.makeBugWatch(remote_bug='b'),
    ...     factory.makeBugWatch(remote_bug='c'),
    ...     ]
    >>> transaction.commit()

    >>> pprint(updater._getRemoteIdsToCheck(
    ...     remote, bug_watches, batch_size=2))
    {'all_remote_ids': [u'a', u'b'],
     'remote_ids_to_check': [u'a', u'b'],
     'unmodified_remote_ids': []}


Querying the remote system for modified bugs
--------------------------------------------

For bug watches that have been checked before, the remote system is
asked which of a list of bugs have been modified since a given date.

    >>> from zope.security.proxy import removeSecurityProxy
    >>> from datetime import datetime
    >>> from pytz import UTC

    >>> class QueryableRemoteSystem:
    ...     sync_comments = False
    ...     def getModifiedRemoteBugs(self, remote_bug_ids, timestamp):
    ...         print "getModifiedRemoteBugs(%r, %r)" % (
    ...             remote_bug_ids, timestamp)
    ...         # Return every *other* bug ID for demo purposes.
    ...         return remote_bug_ids[::2]

    >>> remote = QueryableRemoteSystem()
    >>> now = datetime(2010, 01, 13, 16, 52, tzinfo=UTC)

When there are no bug watches to check, the result is empty, and the
remote system is not queried.

    >>> ids_to_check = updater._getRemoteIdsToCheck(
    ...     remote, [], batch_size=2,
    ...     server_time=now, now=now)

    >>> pprint(ids_to_check)
    {'all_remote_ids': [],
     'remote_ids_to_check': [],
     'unmodified_remote_ids': []}

With up to batch_size previously checked watches, the remote system is
queried once, and we are advised to check only one of the watches.

    >>> bug_watches = [
    ...     factory.makeBugWatch(remote_bug='a'),
    ...     factory.makeBugWatch(remote_bug='b'),
    ...     ]
    >>> for bug_watch in bug_watches:
    ...     removeSecurityProxy(bug_watch).lastchecked = now
    >>> transaction.commit()

    >>> ids_to_check = updater._getRemoteIdsToCheck(
    ...     remote, bug_watches, batch_size=2,
    ...     server_time=now, now=now)
    getModifiedRemoteBugs([u'a', u'b'], datetime.datetime(...))

    >>> pprint(ids_to_check)
    {'all_remote_ids': [u'a', u'b'],
     'remote_ids_to_check': [u'a'],
     'unmodified_remote_ids': [u'b']}

With just more than batch_size previously checked watches, the remote
system is queried twice, and we are advised to check two of the
watches.

    >>> bug_watches = [
    ...     factory.makeBugWatch(remote_bug='a'),
    ...     factory.makeBugWatch(remote_bug='b'),
    ...     factory.makeBugWatch(remote_bug='c'),
    ...     ]
    >>> for bug_watch in bug_watches:
    ...     removeSecurityProxy(bug_watch).lastchecked = now
    >>> transaction.commit()

    >>> ids_to_check = updater._getRemoteIdsToCheck(
    ...     remote, bug_watches, batch_size=2,
    ...     server_time=now, now=now)
    getModifiedRemoteBugs([u'a', u'b'], datetime.datetime(...))
    getModifiedRemoteBugs([u'c'], datetime.datetime(...))

    >>> pprint(ids_to_check)
    {'all_remote_ids': [u'a', u'b', u'c'],
     'remote_ids_to_check': [u'a', u'c'],
     'unmodified_remote_ids': [u'b']}

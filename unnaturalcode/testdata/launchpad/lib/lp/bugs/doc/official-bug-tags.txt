Official Bug Tags
=================

Distributions and products can define official bug tags.

    >>> from zope.component import getUtility
    >>> from lp.registry.interfaces.distribution import IDistributionSet
    >>> from lp.registry.interfaces.product import IProductSet
    >>> from lp.services.database.interfaces import IStore
    >>> from lp.bugs.model.bugtarget import OfficialBugTag
    >>> store = IStore(OfficialBugTag)

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> distro_tag = OfficialBugTag()
    >>> distro_tag.tag = u'PCI'
    >>> distro_tag.target = ubuntu
    >>> store.add(distro_tag)
    <lp.bugs.model.bugtarget.OfficialBugTag object at...

    >>> firefox = getUtility(IProductSet).getByName('firefox')
    >>> product_tag = OfficialBugTag()
    >>> product_tag.tag = u'bar'
    >>> product_tag.target = firefox
    >>> store.add(product_tag)
    <lp.bugs.model.bugtarget.OfficialBugTag object at...

We can add the same bug tag for different products and distributions.

    >>> distro_tag2 = OfficialBugTag()
    >>> distro_tag2.tag = u'foo'
    >>> distro_tag2.distribution = ubuntu
    >>> store.add(distro_tag2)
    <lp.bugs.model.bugtarget.OfficialBugTag object at...
    >>> store.flush()

But bug tags must be unique for each product and distribution.

    >>> distro_tag3 = OfficialBugTag()
    >>> distro_tag3.tag = u'PCI'
    >>> distro_tag3.distribution = ubuntu
    >>> store.add(distro_tag3)
    <lp.bugs.model.bugtarget.OfficialBugTag object at...
    >>> store.flush()
    Traceback (most recent call last):
    IntegrityError: ...

    >>> import transaction
    >>> transaction.abort()


Targets of official bug tags
----------------------------

Distribution owners and other persons with the permission launchpad.Edit
can add and remove offical bug tags by calling addOfficialBugTag()
or removeOfficialBugTag(), respectively.

    >>> login('colin.watson@ubuntulinux.com')
    >>> ubuntu.addOfficialBugTag(u'foo')
    >>> ubuntu.addOfficialBugTag(u'bar')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.distribution==ubuntu)
    >>> result_set = result_set.order_by(OfficialBugTag.tag)
    >>> for tag in result_set:
    ...     print tag.tag
    bar
    foo

    >>> ubuntu.removeOfficialBugTag(u'foo')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.distribution==ubuntu)
    >>> for tag in result_set:
    ...     print tag.tag
    bar

    >>> login('test@canonical.com')
    >>> firefox.addOfficialBugTag(u'foo')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.product==firefox)
    >>> for tag in result_set:
    ...     print tag.tag
    foo

    >>> firefox.removeOfficialBugTag(u'foo')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.product==firefox)
    >>> print result_set.count()
    0

    >>> transaction.commit()

The attempt to add an existing tag a second time succeeds but does not
change the data.

    >>> login('colin.watson@ubuntulinux.com')
    >>> ubuntu.addOfficialBugTag(u'bar')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.distribution==ubuntu)
    >>> result_set = result_set.order_by(OfficialBugTag.tag)
    >>> for tag in result_set:
    ...     print tag.tag
    bar

Similary, deleting an not-existent tag does not lead to an error, but
does not change the data either.

    >>> ubuntu.removeOfficialBugTag(u'foo')
    >>> result_set = store.find(
    ...     OfficialBugTag, OfficialBugTag.distribution==ubuntu)
    >>> for tag in result_set:
    ...     print tag.tag
    bar

Ordinary users cannot add and remove official bug tags.

    >>> login('no-priv@canonical.com')
    >>> ubuntu.addOfficialBugTag(u'foo')
    Traceback (most recent call last):
    ...
    Unauthorized: (<Distribution 'Ubuntu' (ubuntu)>, 'addOfficialBugTag',
    'launchpad.Edit')

    >>> ubuntu.removeOfficialBugTag(u'foo')
    Traceback (most recent call last):
    ...
    Unauthorized: (<Distribution 'Ubuntu' (ubuntu)>, 'removeOfficialBugTag',
    'launchpad.Edit')

    >>> firefox.addOfficialBugTag(u'foo')
    Traceback (most recent call last):
    ...
    Unauthorized: (<Product at ...>, 'addOfficialBugTag', 'launchpad.Edit')

    >>> firefox.removeOfficialBugTag(u'foo')
    Traceback (most recent call last):
    ...
    Unauthorized: (<Product at ...>, 'removeOfficialBugTag', 'launchpad.Edit')

Official tags are accessible as a list property of official tag targets.

    >>> ubuntu.official_bug_tags
    [u'bar']

To set the list, the user must have edit permissions for the target.

    >>> login('colin.watson@ubuntulinux.com')

Setting the list creates any new tags appearing in the list.

    >>> ubuntu.official_bug_tags = [u'foo', u'bar']
    >>> ubuntu.official_bug_tags
    [u'bar', u'foo']

Any existing tags missing from the list are removed.

    >>> ubuntu.official_bug_tags = [u'foo']
    >>> ubuntu.official_bug_tags
    [u'foo']

The list is publicly readable.

    >>> login(ANONYMOUS)
    >>> ubuntu.official_bug_tags
    [u'foo']

But only writable for users with edit permissions.

    >>> login('no-priv@canonical.com')
    >>> ubuntu.official_bug_tags = [u'foo', u'bar']
    Traceback (most recent call last):
    ...
    Unauthorized: (<Distribution 'Ubuntu' (ubuntu)>,
                   'official_bug_tags', 'launchpad.BugSupervisor')

The same is available for products.

    >>> login('test@canonical.com')
    >>> firefox.official_bug_tags = [u'foo', u'bar']
    >>> login(ANONYMOUS)
    >>> firefox.official_bug_tags
    [u'bar', u'foo']


Official tags for additional bug targets
----------------------------------------

All IHasBugs implementations provide an official_bug_tags property. They are
taken from the relevant distribution or product.

Distribution series and distribution source package get the official tags of
their parent distribution.

    >>> ubuntu.getSeries('hoary').official_bug_tags
    [u'foo']

    >>> login('test@canonical.com')
    >>> ubuntu.getSeries(
    ...     'hoary').getSourcePackage('alsa-utils').official_bug_tags
    [u'foo']
    >>> login(ANONYMOUS)

    >>> ubuntu.getSourcePackage('alsa-utils').official_bug_tags
    [u'foo']

Product series gets the tags of the parent product.

    >>> firefox.getSeries('1.0').official_bug_tags
    [u'bar', u'foo']

Project group gets the union of all the tags available for its products.

    >>> login('test@canonical.com')
    >>> from lp.registry.interfaces.projectgroup import IProjectGroupSet
    >>> thunderbird = getUtility(IProductSet).getByName('thunderbird')
    >>> thunderbird.official_bug_tags = [u'baz']
    >>> login('no-priv@canonical.com')
    >>> mozilla = getUtility(IProjectGroupSet).getByName('mozilla')
    >>> list(mozilla.official_bug_tags)
    [u'bar', u'baz', u'foo']
    >>> login(ANONYMOUS)

Milestone gets the tags of the relevant product.

    >>> firefox.getMilestone('1.0').official_bug_tags
    [u'bar', u'foo']


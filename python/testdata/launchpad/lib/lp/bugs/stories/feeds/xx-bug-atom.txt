= Atom Feeds =

Atom feeds produce XML not HTML.  Therefore we must parse the output as XML
using BeautifulStoneSoup instead of BSS or the helper functions.

    >>> from BeautifulSoup import BeautifulStoneSoup as BSS
    >>> from BeautifulSoup import SoupStrainer
    >>> from lp.services.feeds.tests.helper import (
    ...     parse_entries, parse_links, validate_feed)

Please note that when displaying the results of the feeds in a reader
the order of entries may not be the same as generated.  Some readers
will arrange the entries in a different sort order based on the update
time.


== Latest bugs for a product ==

This feed gets the latest bugs reported against a product. The feed
includes summary information about the bugs such as ID, title, author,
and a link to the bug itself. The alternate link for the feed points to
the bugs page for the product, while the alternate link for entries
point to the bugs themselves.

    >>> browser.open('http://feeds.launchpad.dev/jokosher/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in Jokosher']
    >>> browser.url
    'http://feeds.launchpad.dev/jokosher/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2007-03-15:/bugs/jokosher
    >>> alternate_links = parse_links(browser.contents, 'alternate')
    >>> for link in alternate_links:
    ...     print link
    <link rel="alternate" href="http://bugs.launchpad.dev/jokosher" />
    <link rel="alternate" href="http://bugs.launchpad.dev/bugs/12" />
    <link rel="alternate" href="http://bugs.launchpad.dev/bugs/11" />

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/jokosher/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    2
    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [12] Copy, Cut and Delete operations should work on selections
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16
    >>> print extract_text(entry.id)
    tag:launchpad.net,2007-03-15:/bugs/12

    >>> entry = entries[1]
    >>> print extract_text(entry.title)
    [11] Make Jokosher use autoaudiosink
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16
    >>> print extract_text(entry.id)
    tag:launchpad.net,2007-03-15:/bugs/11

The Atom feed must have the content-type of "application/atom+xml".

    >>> browser.headers['content-type']
    'application/atom+xml;charset=utf-8'

== Latest bugs for a project ==

This feed gets the latest bugs for a project, and has the same type of content
as the latest bugs feed for a product.

    >>> browser.open('http://feeds.launchpad.dev/mozilla/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in The Mozilla Project']
    >>> browser.url
    'http://feeds.launchpad.dev/mozilla/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2004-09-24:/bugs/mozilla

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/mozilla/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    5

    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [15] Nonsensical bugs are useless
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> entry = entries[1]
    >>> print extract_text(entry.title)
    [9] Thunderbird crashes
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> entry = entries[2]
    >>> print extract_text(entry.title)
    [5] Firefox install instructions should be complete
    >>> print extract_text(entry.author('name')[0])
    Sample Person
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name12

Ensure the entries are in reverse chronological order by published date.

    >>> def check_entries_order(entries):
    ...     dates = [extract_text(entry.published)
    ...              for entry in entries]
    ...     return dates == sorted(dates, reverse=True)

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")

== Latest bugs for a distro ==

This feed gets the latest bugs for a distribution, and has the same type
of content as the latest bugs feed for a product.

    >>> browser.open('http://feeds.launchpad.dev/ubuntu/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in Ubuntu']
    >>> browser.url
    'http://feeds.launchpad.dev/ubuntu/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2006-10-16:/bugs/ubuntu

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/ubuntu/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    4

    >>> entry = entries[1]
    >>> print extract_text(entry.title)
    [9] Thunderbird crashes
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== Latest bugs for a source package ==

This feed gets the latest bugs for a source package, and has the same
type of content as the latest bugs feed for a product.

    >>> browser.open(
    ...     'http://feeds.launchpad.dev/ubuntu/+source/thunderbird'
    ...     '/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in thunderbird in Ubuntu']
    >>> browser.url
    'http://feeds.launchpad.dev/ubuntu/+source/thunderbird/latest-bugs.atom'
    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2008:/bugs/ubuntu/+source/thunderbird
    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    1
    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [9] Thunderbird crashes
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== Latest bugs for a distroseries ==

This feed gets the latest bugs for a distribution series, and has the same
type of content as the latest bugs feed for a product.

    >>> browser.open(
    ...     'http://feeds.launchpad.dev/ubuntu/hoary/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in Hoary']
    >>> browser.url
    'http://feeds.launchpad.dev/ubuntu/hoary/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2006-10-16:/bugs/ubuntu/hoary

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/ubuntu/hoary/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    1

    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [2] Blackhole Trash folder
    >>> print extract_text(entry.author('name')[0])
    Sample Person
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name12

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== Latest bugs for a product series ==

This feed gets the latest bugs for a product series, and has the same
type of content as the latest bugs feed for a product.

    >>> browser.open(
    ...     'http://feeds.launchpad.dev/firefox/1.0/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs in 1.0']
    >>> browser.url
    'http://feeds.launchpad.dev/firefox/1.0/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2005-06-06:/bugs/firefox/1.0

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/firefox/1.0/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    1

    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [5] Firefox install instructions should be complete
    >>> print extract_text(entry.author('name')[0])
    Sample Person
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name12

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== Latest bugs for a person ==

This feed gets the latest bugs for a person.

    >>> browser.open('http://feeds.launchpad.dev/~name16/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs for Foo Bar']
    >>> browser.url
    'http://feeds.launchpad.dev/~name16/latest-bugs.atom'

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2005-06-06:/bugs/~name16

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/~name16/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    7

    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [15] Nonsensical bugs are useless
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> entry = entries[1]
    >>> print extract_text(entry.title)
    [12] Copy, Cut and Delete operations should work on selections
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== Latest bugs for a team ==

This feed gets the latest bugs for a whole team.
First, make a team responsible for some bugs.

    >>> from zope.component import getUtility
    >>> from lp.registry.interfaces.person import IPersonSet
    >>> one_mem_browser = setupBrowser(
    ...    auth='Basic one-membership@test.com:test')
    >>> personset = getUtility(IPersonSet)

Subscribe simple-team to a number of bugs.

    >>> one_mem_browser.open('http://launchpad.dev/bugs/1')
    >>> one_mem_browser.getLink('Subscribe someone else').click()
    >>> one_mem_browser.getControl('Person').value = 'simple-team'
    >>> one_mem_browser.getControl('Subscribe user').click()

    >>> one_mem_browser.open('http://launchpad.dev/bugs/2')
    >>> one_mem_browser.getLink('Subscribe someone else').click()
    >>> one_mem_browser.getControl('Person').value = 'simple-team'
    >>> one_mem_browser.getControl('Subscribe user').click()

    >>> one_mem_browser.open('http://launchpad.dev/bugs/3')
    >>> one_mem_browser.getLink('Subscribe someone else').click()
    >>> one_mem_browser.getControl('Person').value = 'simple-team'
    >>> one_mem_browser.getControl('Subscribe user').click()


Now we can do a query on the lastest bugs for simple team and expect
some results.

    >>> browser.open(
    ...    'http://feeds.launchpad.dev/~simple-team/latest-bugs.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bugs for Simple Team']

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> print extract_text(soup.find('id'))
    tag:launchpad.net,2007-02-21:/bugs/~simple-team

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/~simple-team/latest-bugs.atom" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    3

    >>> assert check_entries_order(entries), (
    ...     "Published dates are not sorted.")


== General bug search ==

This feed is the most useful of them all. Any bug search can be turned into
a feed.

    >>> url = ("http://feeds.launchpad.dev/bugs/+bugs.atom?"
    ...        "field.searchtext=&search=Search+Bug+Reports&"
    ...        "field.scope=all&field.scope.target=")

The bug search feed is not enabled by default since it may represent a
performance problem in production.

    >>> from zope.security.interfaces import Unauthorized
    >>> from lp.services.config import config
    >>> config.launchpad.is_bug_search_feed_active
    True
    >>> bug_search_feed_data = """
    ...     [launchpad]
    ...     is_bug_search_feed_active: False
    ...     """
    >>> config.push('bug_search_feed_data', bug_search_feed_data)
    >>> browser.open(url)
    Traceback (most recent call last):
    ...
    Unauthorized: Bug search feed deactivated

    # Restore the config.
    >>> config_data = config.pop('bug_search_feed_data')

The bug search feed can be tested after setting is_bug_search_feed_active
to True.

    >>> browser.open(url)
    >>> BSS(browser.contents).title.contents
    [u'Bugs from custom search']

    >>> soup = BSS(browser.contents, parseOnlyThese=SoupStrainer('id'))
    >>> feed_id = extract_text(soup.find('id'))
    >>> print feed_id
    tag:launchpad.net,2008:/+bugs.atom?field.scope.target=&amp;field.scope=all&amp;field.searchtext=&amp;search=Search+Bug+Reports

    >>> from lp.services.webapp.escaping import html_escape
    >>> print html_escape(browser.url)
    http://feeds.launchpad.dev/bugs/+bugs.atom?field.scope.target=&amp;field.scope=all&amp;field.searchtext=&amp;search=Search+Bug+Reports

    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/bugs/+bugs.atom?field.scope.target=&amp;field.scope=all&amp;field.searchtext=&amp;search=Search+Bug+Reports" />

    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    12

    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [15] Nonsensical bugs are useless
    >>> print extract_text(entry.author('name')[0])
    Foo Bar
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name16

    >>> entry = entries[1]
    >>> print extract_text(entry.title)
    [13] Launchpad CSS and JS is not testible
    >>> print extract_text(entry.author('name')[0])
    Sample Person
    >>> print extract_text(entry.author('uri')[0])
    http://bugs.launchpad.dev/~name12


== Results for a single bug ==

This feed shows the status of a single bug.

    >>> browser.open('http://feeds.launchpad.dev/bugs/1/bug.atom')
    >>> validate_feed(browser.contents,
    ...              browser.headers['content-type'], browser.url)
    No Errors
    >>> BSS(browser.contents).title.contents
    [u'Bug 1']
    >>> entries = parse_entries(browser.contents)
    >>> print len(entries)
    1
    >>> entry = entries[0]
    >>> print extract_text(entry.title)
    [1] Firefox does not support SVG
    >>> self_links = parse_links(browser.contents, 'self')
    >>> for link in self_links:
    ...     print link
    <link rel="self" href="http://feeds.launchpad.dev/bugs/1/bug.atom" />

== Feeds Configuration Options ==

The max_bug_feed_cache_minutes configuration is provided to allow
overriding the Expires and Cache-Control headers so that the feeds
will be cached longer by browsers and the reverse-proxy in front
of the feeds servers.

    >>> import time
    >>> old_time = time.time
    >>> time.time = lambda: 17
    >>> browser.open('http://feeds.launchpad.dev/bugs/1/bug.atom')
    >>> config.launchpad.max_bug_feed_cache_minutes
    30
    >>> browser.headers['Expires']
    'Thu, 01 Jan 1970 00:30:17 GMT'
    >>> browser.headers['Cache-Control']
    'max-age=1800'
    >>> time.time = old_time
